<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>HackGuardian - Vulnérabilités</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <div class="container py-4">

    <!-- Barre de titre + lien de connexion -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>HackGuardian - Veille de Vulnérabilités</h1>
      {% if session.get('user_id') %}
        <a href="/dashboard" class="btn btn-outline-primary">Dashboard</a>
      {% else %}
        <a href="/login" class="btn btn-outline-primary">Se connecter</a>
      {% endif %}
    </div>

    <!-- Filtres -->
    <div class="row mb-3">
      <div class="col-md-3">
        <input type="text" id="filter-product" class="form-control" placeholder="Rechercher un produit">
      </div>
      <div class="col-md-3">
        <select id="filter-severity" class="form-select">
          <option value="">Gravité</option>
          <option value="Critique">Critique</option>
          <option value="Haute">Haute</option>
          <option value="Moyenne">Moyenne</option>
          <option value="Faible">Faible</option>
        </select>
      </div>
      <div class="col-md-3">
        <input type="date" id="filter-date" class="form-control">
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary w-100" onclick="applyFilters()">Appliquer</button>
      </div>
    </div>

    <!-- Tableau CVE -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover bg-white">
        <thead class="table-dark">
          <tr>
            <th>ID CVE</th>
            <th>Titre</th>
            <th>Produit</th>
            <th>Gravité</th>
            <th>Date</th>
            <th>Source</th>
            <th>Détail</th>
          </tr>
        </thead>
        <tbody id="cve-table-body">
          <!-- JS va insérer ici -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let cveData = [];

    async function loadData() {
      const response = await fetch('/api/cves');
      cveData = await response.json();
      displayTable(cveData);
    }

    function displayTable(data) {
      const tbody = document.getElementById('cve-table-body');
      tbody.innerHTML = '';
      data.forEach(cve => {
        tbody.innerHTML += `
          <tr>
            <td>${cve.id}</td>
            <td>${cve.title}</td>
            <td>${cve.product}</td>
            <td><span class="badge bg-${getColor(cve.severity)}">${cve.severity}</span></td>
            <td>${cve.date}</td>
            <td>${cve.source}</td>
            <td><a href="${cve.link}" class="btn btn-sm btn-outline-primary" target="_blank">Voir</a></td>
          </tr>`;
      });
    }

    function getColor(severity) {
      return {
        'Critique': 'danger',
        'Haute': 'warning',
        'Moyenne': 'info',
        'Faible': 'secondary'
      }[severity] || 'light';
    }

    function applyFilters() {
      const product = document.getElementById('filter-product').value.toLowerCase();
      const severity = document.getElementById('filter-severity').value;
      const date = document.getElementById('filter-date').value;

      const filtered = cveData.filter(cve =>
        (!product || cve.product.toLowerCase().includes(product)) &&
        (!severity || cve.severity === severity) &&
        (!date || cve.date === date)
      );

      displayTable(filtered);
    }

    loadData();
  </script>
</body>
</html>